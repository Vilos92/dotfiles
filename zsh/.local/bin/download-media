#!/bin/sh

if [ "$#" -lt 1 ]; then
    echo "Error: You must provide a video URL." >&2
    echo "Usage: $0 <video_url> [--audio] [--index]" >&2
    exit 1
fi

URL="$1"
DOWNLOAD_AUDIO=false
ADD_PLAYLIST_INDEX=false

# Shift the arguments to iterate through the rest.
shift

while [ "$#" -gt 0 ]; do
    if [ "$1" = "--audio" ]; then
        DOWNLOAD_AUDIO=true
    elif [ "$1" = "--index" ]; then
        ADD_PLAYLIST_INDEX=true
    fi
    shift
done

OUTPUT_TEMPLATE="%(title)s.%(ext)s"
if [ "$ADD_PLAYLIST_INDEX" = true ]; then
    OUTPUT_TEMPLATE="%(playlist_index)s - $OUTPUT_TEMPLATE"
fi

if [ "$DOWNLOAD_AUDIO" = true ]; then
    # Download the highest quality audio and convert it to MP3.
    echo "Downloading audio from $URL..."
    yt-dlp -x --audio-format mp3 --audio-quality 0 --output "$OUTPUT_TEMPLATE" "$URL"
else
    # Download the highest quality video with forced merge to MP4.
    echo "Downloading video from $URL..."
    yt-dlp -f "bv*+ba/b" --merge-output-format mp4 --remux-video mp4 --output "$OUTPUT_TEMPLATE" "$URL"
fi
