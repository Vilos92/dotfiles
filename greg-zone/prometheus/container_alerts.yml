groups:
- name: container_health
  rules:
  # Container is down/stopped (using docker-stats-exporter)
  - alert: ContainerDown
    expr: absent(container_cpu_usage_percent{job="docker-stats",name="tailscale"}) or absent(container_cpu_usage_percent{job="docker-stats",name="nginx-tailscale"}) or absent(container_cpu_usage_percent{job="docker-stats",name="cloudflared"}) or absent(container_cpu_usage_percent{job="docker-stats",name="nginx-cloudflared"}) or absent(container_cpu_usage_percent{job="docker-stats",name="copyparty"}) or absent(container_cpu_usage_percent{job="docker-stats",name="kiwix"}) or absent(container_cpu_usage_percent{job="docker-stats",name="freshrss"}) or absent(container_cpu_usage_percent{job="docker-stats",name="transmission"}) or absent(container_cpu_usage_percent{job="docker-stats",name="prometheus"}) or absent(container_cpu_usage_percent{job="docker-stats",name="alertmanager"}) or absent(container_cpu_usage_percent{job="docker-stats",name="discord-webhook"}) or absent(container_cpu_usage_percent{job="docker-stats",name="services-alert-monitor"}) or absent(container_cpu_usage_percent{job="docker-stats",name="infrastructure-alert-monitor"}) or absent(container_cpu_usage_percent{job="docker-stats",name="minecraft-alert-monitor"}) or absent(container_cpu_usage_percent{job="docker-stats",name="grafana"}) or absent(container_cpu_usage_percent{job="docker-stats",name="node-exporter"}) or absent(container_cpu_usage_percent{job="docker-stats",name="docker-stats-exporter"}) or absent(container_cpu_usage_percent{job="docker-stats",name="cadvisor"}) or absent(container_cpu_usage_percent{job="docker-stats",name="loki"}) or absent(container_cpu_usage_percent{job="docker-stats",name="promtail"}) or absent(container_cpu_usage_percent{job="docker-stats",name="minecraft"}) or absent(container_cpu_usage_percent{job="docker-stats",name="minecraft-backup"}) or absent(container_cpu_usage_percent{job="docker-stats",name="playit"}) or absent(container_cpu_usage_percent{job="docker-stats",name="mc-monitor"}) or absent(container_cpu_usage_percent{job="docker-stats",name="infra-redis"}) or absent(container_cpu_usage_percent{job="docker-stats",name="infra-redis-commander"})
    for: 30s
    labels:
      severity: critical
    annotations:
      summary: "Container {{ $labels.name }} is down"
      description: "Container {{ $labels.name }} has stopped reporting metrics for more than 30 seconds."

  # Container restarting frequently
  - alert: ContainerRestarting
    expr: rate(container_start_time_seconds{job="docker-stats",name=~"tailscale|nginx-tailscale|cloudflared|nginx-cloudflared|copyparty|kiwix|freshrss|transmission|prometheus|alertmanager|discord-webhook|services-alert-monitor|infrastructure-alert-monitor|minecraft-alert-monitor|grafana|node-exporter|docker-stats-exporter|cadvisor|loki|promtail|minecraft|minecraft-backup|playit|mc-monitor|infra-redis|infra-redis-commander"}[5m]) > 0.1
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "Container {{ $labels.name }} is restarting frequently"
      description: "Container {{ $labels.name }} has restarted more than 6 times in the last 5 minutes (rate > 0.1 restarts/second)."

  # High memory usage
  - alert: ContainerHighMemoryUsage
    expr: (container_memory_usage_bytes{job="docker-stats",name=~"tailscale|nginx-tailscale|cloudflared|nginx-cloudflared|copyparty|kiwix|freshrss|transmission|prometheus|alertmanager|discord-webhook|services-alert-monitor|infrastructure-alert-monitor|minecraft-alert-monitor|grafana|node-exporter|docker-stats-exporter|cadvisor|loki|promtail|minecraft|minecraft-backup|playit|mc-monitor|infra-redis|infra-redis-commander"} / container_memory_limit_bytes{job="docker-stats",name=~"tailscale|nginx-tailscale|cloudflared|nginx-cloudflared|copyparty|kiwix|freshrss|transmission|prometheus|alertmanager|discord-webhook|services-alert-monitor|infrastructure-alert-monitor|minecraft-alert-monitor|grafana|node-exporter|docker-stats-exporter|cadvisor|loki|promtail|minecraft|minecraft-backup|playit|mc-monitor|infra-redis|infra-redis-commander"}) > 0.9
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Container {{ $labels.name }} high memory usage"
      description: "Container {{ $labels.name }} is using {{ $value | humanizePercentage }} of its memory limit (threshold: >90% for 5 minutes)."

  # High CPU usage
  - alert: ContainerHighCPUUsage
    expr: container_cpu_usage_percent{job="docker-stats",name=~"tailscale|nginx-tailscale|cloudflared|nginx-cloudflared|copyparty|kiwix|freshrss|transmission|prometheus|alertmanager|discord-webhook|services-alert-monitor|infrastructure-alert-monitor|minecraft-alert-monitor|grafana|node-exporter|docker-stats-exporter|cadvisor|loki|promtail|minecraft|minecraft-backup|playit|mc-monitor|infra-redis|infra-redis-commander"} > 80
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Container {{ $labels.name }} high CPU usage"
      description: "Container {{ $labels.name }} is using {{ $value }}% CPU (threshold: >80% for 5 minutes)."

  # Disk space running low
  - alert: ContainerHighDiskUsage
    expr: (container_fs_usage_bytes{job="docker-stats",name=~"tailscale|nginx-tailscale|cloudflared|nginx-cloudflared|copyparty|kiwix|freshrss|transmission|prometheus|alertmanager|discord-webhook|services-alert-monitor|infrastructure-alert-monitor|minecraft-alert-monitor|grafana|node-exporter|docker-stats-exporter|cadvisor|loki|promtail|minecraft|minecraft-backup|playit|mc-monitor|infra-redis|infra-redis-commander"} / container_fs_limit_bytes{job="docker-stats",name=~"tailscale|nginx-tailscale|cloudflared|nginx-cloudflared|copyparty|kiwix|freshrss|transmission|prometheus|alertmanager|discord-webhook|services-alert-monitor|infrastructure-alert-monitor|minecraft-alert-monitor|grafana|node-exporter|docker-stats-exporter|cadvisor|loki|promtail|minecraft|minecraft-backup|playit|mc-monitor|infra-redis|infra-redis-commander"}) > 0.9
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Container {{ $labels.name }} high disk usage"
      description: "Container {{ $labels.name }} is using {{ $value | humanizePercentage }} of its disk space (threshold: >90% for 5 minutes)."

  # Container OOMKilled
  - alert: ContainerOOMKilled
    expr: increase(container_oom_events_total{job="docker-stats",name=~"tailscale|nginx-tailscale|cloudflared|nginx-cloudflared|copyparty|kiwix|freshrss|transmission|prometheus|alertmanager|discord-webhook|services-alert-monitor|infrastructure-alert-monitor|minecraft-alert-monitor|grafana|node-exporter|docker-stats-exporter|cadvisor|loki|promtail|minecraft|minecraft-backup|playit|mc-monitor|infra-redis|infra-redis-commander"}[1h]) > 0
    for: 0s
    labels:
      severity: critical
    annotations:
      summary: "Container {{ $labels.name }} was OOMKilled"
      description: "Container {{ $labels.name }} was killed due to out of memory (OOM events detected in the last hour)."

- name: service_health
  rules:
