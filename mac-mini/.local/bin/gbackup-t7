#!/bin/sh

# ==============================================================================
#
#                            !!! IMPORTANT !!!
#
# This script performs a ONE-WAY MIRROR backup.
#
# The T7 drive is the DESTINATION. It is intended to be an exact copy
# of selected Wokyis Vault folders.
#
# Data flows FROM:
#   - /Volumes/Wokyis M.2 SSD - Storage/Vaults/GregZone Vault/
#   - /Volumes/Wokyis M.2 SSD - Storage/Vaults/Hobby Vault/
#
# Data flows TO:
#   - /Volumes/T7/Vaults/GregZone Vault/
#   - /Volumes/T7/Vaults/Hobby Vault/
#
# Because this script uses the --delete flag, any file that exists on the
# T7 drive but NOT in the source Mac Vault will be PERMANENTLY DELETED from
# the T7 drive during the sync.
#
# DO NOT STORE UNIQUE FILES IN THE T7 MAC VAULT DIRECTORY.
#
# ==============================================================================

# --- 🛡️ Safety Check & Global Options ---
# This script is in DRY-RUN mode by default.
# Pass the --execute flag as the first argument to make real changes.
RSYNC_OPTS="-av --progress --delete --stats" # Base options
if [ "$1" == "--execute" ]; then
    echo "✅ --execute flag detected. Live backup mode engaged."
else
    echo "🛡️ SAFE MODE: Running in simulation (dry-run) mode."
    RSYNC_OPTS="$RSYNC_OPTS --dry-run"
fi
echo "===================================================="


# --- Safety Checks ---
if [ ! -d "/Volumes/T7" ]; then
    echo "❌ ERROR: Samsung T7 drive not found at /Volumes/T7"
    echo "   Please ensure your Samsung T7 drive is connected and mounted"
    exit 1
fi

if [ ! -d "/Volumes/Wokyis M.2 SSD - Storage" ]; then
    echo "❌ ERROR: Wokyis drive not found at /Volumes/Wokyis M.2 SSD - Storage"
    echo "   Please ensure your Wokyis drive is connected and mounted"
    exit 1
fi

GZ_SOURCE_BASE="/Volumes/Wokyis M.2 SSD - Storage/Vaults/GregZone Vault"
HB_SOURCE_BASE="/Volumes/Wokyis M.2 SSD - Storage/Vaults/Hobby Vault"

if [ ! -d "$GZ_SOURCE_BASE" ]; then
    echo "❌ ERROR: GregZone Vault not found at $GZ_SOURCE_BASE"
    exit 1
fi

if [ ! -d "$HB_SOURCE_BASE" ]; then
    echo "❌ ERROR: Hobby Vault not found at $HB_SOURCE_BASE"
    exit 1
fi

echo "✅ Source GregZone Vault found: $GZ_SOURCE_BASE"
echo "✅ Source Hobby Vault found: $HB_SOURCE_BASE"
echo "✅ Target Samsung T7 drive found: /Volumes/T7"
echo "===================================================="


# --- Ensure destination directories exist ---
mkdir -p "/Volumes/T7/Vaults/GregZone Vault" "/Volumes/T7/Vaults/Hobby Vault"

# --- GregZone Vault Backup (Wokyis -> T7) ---
echo "▶️  Starting GregZone Vault backup"
GZ_DEST_BASE="/Volumes/T7/Vaults/GregZone Vault"
echo "🔄 Syncing: $GZ_SOURCE_BASE -> $GZ_DEST_BASE"
rsync $RSYNC_OPTS "$GZ_SOURCE_BASE/" "$GZ_DEST_BASE/"
echo "----------------------------------------------------"

# --- Hobby Vault Backup (Wokyis -> T7) ---
echo "▶️  Starting Hobby Vault backup"
HB_DEST_BASE="/Volumes/T7/Vaults/Hobby Vault"
echo "🔄 Syncing: $HB_SOURCE_BASE -> $HB_DEST_BASE"
rsync $RSYNC_OPTS "$HB_SOURCE_BASE/" "$HB_DEST_BASE/"
echo "----------------------------------------------------"

echo "✅ All backup stages finished."
